<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luxury Admin - نظام إدارة المنتجات</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* سأحتفظ بتنسيقات صديقك مع إضافة تنسيقات واجهة التوكن */
        :root {
            --primary: #1a2a6c;
            --accent: #ff5e00;
        }
        
        /* كود صديقك الأصلي هنا (تم اختصاره للعرض) */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #f5f7fa; color: #333; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; display: none; } /* مخفي حتى يتم التأكد من التوكن */
        
        /* واجهة طلب التوكن الجديدة */
        #authOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            z-index: 9999; display: flex; align-items: center; justify-content: center;
        }
        .auth-card {
            background: white; padding: 40px; border-radius: 15px; box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            width: 90%; max-width: 400px; text-align: center;
        }
        .auth-card i { font-size: 50px; color: var(--primary); margin-bottom: 20px; }
        .auth-card input {
            width: 100%; padding: 12px; margin: 20px 0; border: 2px solid #ddd; border-radius: 8px;
            text-align: center; font-family: monospace;
        }
        .auth-card .btn-login {
            background: var(--primary); color: white; border: none; padding: 12px 30px;
            border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%;
        }
        .error-msg { color: #e53935; font-size: 14px; margin-top: 10px; display: none; }
        
        /* تأثير الهزة عند الخطأ */
        .shake { animation: shake 0.5s; border-color: #e53935 !important; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        /* تنسيقات إضافية لزر رفع الصورة */
        .image-preview { width: 100px; height: 100px; border: 2px dashed #ddd; margin-top: 10px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .image-preview img { max-width: 100%; }

        /* باقي تنسيقات صديقك */
        header { background: linear-gradient(135deg, #1a2a6c, #2d4196); color: white; padding: 20px; border-radius: 10px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }
        .add-product-btn { background: linear-gradient(to right, #ff9a00, #ff5e00); color: white; border: none; padding: 12px 25px; border-radius: 50px; cursor: pointer; font-weight: bold; }
        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; }
        .product-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; }
        .modal-content { background: white; width: 90%; max-width: 700px; margin: 50px auto; border-radius: 12px; }
        .conditional-section { display: none; padding: 15px; background: #f9f9f9; border-radius: 8px; margin-top: 15px; }
    </style>
</head>
<body>

    <div id="authOverlay">
        <div class="auth-card">
            <i class="fas fa-user-shield"></i>
            <h2>دخول المشرف</h2>
            <p>يرجى إدخال التوكن الخاص بك للوصول</p>
            <input type="password" id="tokenInput" placeholder="ghp_xxxxxxxxxxxx">
            <button class="btn-login" onclick="verifyToken()">تحقق ودخول</button>
            <p class="error-msg" id="errorMsg">التوكن غير صحيح! حاول مجدداً.</p>
        </div>
    </div>

    <div class="container" id="mainApp">
        <header>
            <div class="logo"><i class="fas fa-store"></i> <h1>لوحة التحكم الفاخرة</h1></div>
            <button class="add-product-btn" id="addProductBtn"><i class="fas fa-plus-circle"></i> إضافة منتج جديد</button>
        </header>
        
        <main>
            <div class="products-grid" id="productsGrid"></div>
            <div class="empty-state" id="emptyState" style="text-align:center; padding:50px;">
                <i class="fas fa-box-open" style="font-size: 50px; color:#ddd;"></i>
                <h3>لا توجد منتجات</h3>
            </div>
        </main>
    </div>

    <div class="modal" id="productModal">
        <div class="modal-content">
            <div class="modal-header" style="background: #1a2a6c; color: white; padding: 20px; display: flex; justify-content: space-between;">
                <h2 id="modalTitle">إضافة منتج جديد</h2>
                <span style="cursor:pointer; font-size:24px;" onclick="closeProductModal()">&times;</span>
            </div>
            <form id="productForm">
                <div style="padding: 20px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <label>عنوان المنتج</label>
                            <input type="text" id="productTitle" class="form-control" style="width:100%; padding:10px; margin-bottom:15px;" required>
                            
                            <label>فئة المنتج</label>
                            <select id="productCategory" class="form-control" style="width:100%; padding:10px; margin-bottom:15px;">
                                <option value="Free Fire">Free Fire</option>
                                <option value="Efootball">Efootball</option>
                            </select>

                            <label>صورة المنتج (من الجهاز)</label>
                            <input type="file" id="productImageFile" accept="image/*" style="margin-bottom:10px;">
                            <div class="image-preview" id="imagePreview">بدون صورة</div>
                        </div>
                        
                        <div>
                            <label>رابط البائع</label>
                            <input type="url" id="sellerLink" class="form-control" style="width:100%; padding:10px; margin-bottom:15px;" required>
                            
                            <label>صيغة المنتج</label>
                            <select id="productFormat" class="form-control" style="width:100%; padding:10px;">
                                <option value="">اختر</option>
                                <option value="بيع">بيع</option>
                                <option value="طلب">طلب</option>
                                <option value="تبادل">تبادل</option>
                            </select>
                        </div>
                    </div>

                    <div class="conditional-section" id="priceSection">
                        <label>السعر بالدولار</label> <input type="number" id="priceDollar" style="width:100%; padding:10px;">
                        <label>السعر بالدينار</label> <input type="number" id="priceDinar" style="width:100%; padding:10px;">
                    </div>
                </div>
                <div style="padding: 20px; text-align: left; background: #f9f9f9;">
                    <button type="button" onclick="closeProductModal()" style="padding:10px 20px;">إلغاء</button>
                    <button type="submit" id="saveBtn" style="padding:10px 20px; background: #1a2a6c; color:white; border:none; cursor:pointer;">حفظ ونشر</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // إعدادات GitHub (يجب تغيير هذه القيم)
        const GITHUB_CONFIG = {
            owner: 'YOUR_USERNAME', // اسم حسابك في جيت هب
            repo: 'YOUR_REPO_NAME', // اسم المستودع
            jsonPath: 'data/products.json', // مسار ملف المنتجات
            imageFolder: 'assets/uploads' // مجلد الصور
        };

        let GITHUB_TOKEN = '';

        // 1. التحقق من التوكن عند فتح الصفحة
        window.onload = () => {
            const savedToken = localStorage.getItem('luxury_token');
            if (savedToken) {
                document.getElementById('tokenInput').value = savedToken;
                verifyToken();
            }
        };

        async function verifyToken() {
            const input = document.getElementById('tokenInput');
            const token = input.value.trim();
            const btn = document.querySelector('.btn-login');

            btn.innerText = 'جاري التحقق...';
            
            try {
                const res = await fetch('https://api.github.com/user', {
                    headers: { 'Authorization': `token ${token}` }
                });

                if (res.ok) {
                    GITHUB_TOKEN = token;
                    localStorage.setItem('luxury_token', token);
                    document.getElementById('authOverlay').style.fadeOut = "slow";
                    document.getElementById('authOverlay').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'block';
                    loadProductsFromGithub();
                } else {
                    throw new Error();
                }
            } catch (e) {
                input.classList.add('shake');
                document.getElementById('errorMsg').style.display = 'block';
                setTimeout(() => input.classList.remove('shake'), 500);
            } finally {
                btn.innerText = 'تحقق ودخول';
            }
        }

        // 2. معالجة معاينة الصورة
        document.getElementById('productImageFile').onchange = function(e) {
            const reader = new FileReader();
            reader.onload = function() {
                const img = document.getElementById('imagePreview');
                img.innerHTML = `<img src="${reader.result}">`;
            };
            reader.readAsDataURL(e.target.files[0]);
        };

        // 3. وظيفة الرفع المزدوج (الصورة ثم الـ JSON) دون فقدان الجودة
        async function uploadToGithub(productData, file) {
            const saveBtn = document.getElementById('saveBtn');
            saveBtn.innerText = 'جاري رفع الصورة...';

            let imageUrl = '';

            // أولاً: رفع الصورة إذا وجدت
            if (file) {
                const fileName = `img_${Date.now()}_${file.name}`;
                const base64Content = await toBase64(file);
                const cleanBase64 = base64Content.split(',')[1];

                const imgRes = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.imageFolder}/${fileName}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: `Upload image ${fileName}`,
                        content: cleanBase64
                    })
                });
                
                if (imgRes.ok) {
                    const imgData = await imgRes.json();
                    imageUrl = imgData.content.download_url;
                }
            }

            saveBtn.innerText = 'تحديث البيانات...';
            productData.image = imageUrl;

            // ثانياً: تحديث ملف JSON
            await updateJsonFile(productData);
            
            saveBtn.innerText = 'حفظ ونشر';
            closeProductModal();
            loadProductsFromGithub();
        }

        async function updateJsonFile(newProduct) {
            // جلب النسخة القديمة للحصول على الـ SHA (بصمة الملف)
            const res = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.jsonPath}`, {
                headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
            });

            let sha = '';
            let currentProducts = [];

            if (res.ok) {
                const data = await res.json();
                sha = data.sha;
                currentProducts = JSON.parse(atob(data.content));
            }

            currentProducts.push(newProduct);

            await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.jsonPath}`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: 'Add new product',
                    content: btoa(unescape(encodeURIComponent(JSON.stringify(currentProducts, null, 2)))),
                    sha: sha
                })
            });
        }

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        // 4. ربط النموذج بوظيفة الرفع
        document.getElementById('productForm').onsubmit = async (e) => {
            e.preventDefault();
            const file = document.getElementById('productImageFile').files[0];
            const data = {
                id: Date.now(),
                title: document.getElementById('productTitle').value,
                category: document.getElementById('productCategory').value,
                format: document.getElementById('productFormat').value,
                priceDollar: document.getElementById('priceDollar').value,
                priceDinar: document.getElementById('priceDinar').value,
                sellerLink: document.getElementById('sellerLink').value
            };
            await uploadToGithub(data, file);
        };

        // دوال مساعدة لفتح وإغلاق المودال
        document.getElementById('addProductBtn').onclick = () => document.getElementById('productModal').style.display='block';
        function closeProductModal() { document.getElementById('productModal').style.display='none'; }
        
        // إظهار/إخفاء الأقسام (نفس منطق صديقك)
        document.getElementById('productFormat').onchange = function() {
            document.getElementById('priceSection').style.display = (this.value === 'بيع') ? 'block' : 'none';
        };

        async function loadProductsFromGithub() {
            // هنا تضع كود عرض المنتجات من ملف الـ JSON
            // سيعمل المتجر على قراءة نفس الملف لعرض المنتجات للزبائن
        }
    </script>
</body>
</html>
