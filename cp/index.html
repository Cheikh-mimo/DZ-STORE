<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… DZ-STORE</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        * { font-family: 'Cairo', sans-serif; box-sizing: border-box; }
        body { background-color: #f4f7f6; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 800px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #1a2a6c; border-bottom: 2px solid #ff9a00; padding-bottom: 10px; }
        
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        
        .btn-submit { 
            width: 100%; padding: 15px; background: #1a2a6c; color: white; 
            border: none; border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: bold;
            transition: 0.3s;
        }
        .btn-submit:hover { background: #ff9a00; }
        
        #status { margin-top: 20px; padding: 15px; border-radius: 8px; display: none; text-align: center; }
        .success { background: #d4edda; color: #155724; display: block !important; }
        .error { background: #f8d7da; color: #721c24; display: block !important; }
        
        .preview-img { max-width: 100px; margin-top: 10px; border-radius: 5px; display: none; }
    </style>
</head>
<body>

<div class="container">
    <h2><i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯ - DZ-STORE</h2>
    
    <div id="status"></div>

    <div class="form-group">
        <label>Ø§Ø³Ù… Ø§Ù„Ù„Ø¹Ø¨Ø© / Ø§Ù„Ø®Ø¯Ù…Ø©:</label>
        <input type="text" id="title" placeholder="Ù…Ø«Ø§Ù„: Free Fire 1000 Diamonds">
    </div>

    <div class="form-group">
        <label>Ø§Ù„ØªØµÙ†ÙŠÙ:</label>
        <select id="category">
            <option value="Ø¨Ø·Ø§Ù‚Ø§Øª Ø´Ø­Ù†">Ø¨Ø·Ø§Ù‚Ø§Øª Ø´Ø­Ù†</option>
            <option value="Ø­Ø³Ø§Ø¨Ø§Øª Ø£Ù„Ø¹Ø§Ø¨">Ø­Ø³Ø§Ø¨Ø§Øª Ø£Ù„Ø¹Ø§Ø¨</option>
            <option value="Ø®Ø¯Ù…Ø§Øª Ø£Ø®Ø±Ù‰">Ø®Ø¯Ù…Ø§Øª Ø£Ø®Ø±Ù‰</option>
        </select>
    </div>

    <div class="form-group">
        <label>Ø§Ù„Ø³Ø¹Ø± (Ø¨Ø§Ù„Ø¯ÙŠÙ†Ø§Ø± Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±ÙŠ):</label>
        <input type="number" id="priceDinar" placeholder="2500">
    </div>

    <div class="form-group">
        <label>Ø§Ù„Ø³Ø¹Ø± (Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø±):</label>
        <input type="number" id="priceDollar" placeholder="12">
    </div>

    <div class="form-group">
        <label>Ø±Ø§Ø¨Ø· Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„Ø´Ø±Ø§Ø¡:</label>
        <input type="url" id="sellerLink" placeholder="https://wa.me/213xxxxxxx">
    </div>

    <div class="form-group">
        <label>ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬:</label>
        <input type="file" id="imageInput" accept="image/*">
        <img id="preview" class="preview-img">
    </div>

    <button class="btn-submit" id="submitBtn" onclick="uploadProduct()">
        <i class="fas fa-cloud-upload-alt"></i> Ù†Ø´Ø± Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¢Ù†
    </button>
</div>

<script>
    // --- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ ---
    const GITHUB_TOKEN = 'Ø¶Ø¹_Ø§Ù„ØªÙˆÙƒÙ†_Ù‡Ù†Ø§'; // Ø¶Ø¹ Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù‡Ù†Ø§
    const REPO_OWNER = 'Cheikh-mimo';
    const REPO_NAME = 'DZ-STORE';
    const JSON_PATH = 'data/products.json';

    // Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø±ÙØ¹
    document.getElementById('imageInput').onchange = function(evt) {
        const [file] = this.files;
        if (file) {
            document.getElementById('preview').src = URL.createObjectURL(file);
            document.getElementById('preview').style.display = 'block';
        }
    }

    async function uploadProduct() {
        const btn = document.getElementById('submitBtn');
        const status = document.getElementById('status');
        const fileInput = document.getElementById('imageInput');
        
        if (!fileInput.files[0]) return alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©!");

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...';

        try {
            // 1. ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Base64
            const imageBase64 = await toBase64(fileInput.files[0]);
            const imageName = `img_${Date.now()}.png`;
            const imagePath = `assets/uploads/${imageName}`;

            // 2. Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹
            const imgRes = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${imagePath}`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: "Upload new image",
                    content: imageBase64.split(',')[1]
                })
            });

            const imgData = await imgRes.json();
            const imageUrl = imgData.content.download_url;

            // 3. Ø¬Ù„Ø¨ Ù…Ù„Ù JSON Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆØªØ­Ø¯ÙŠØ«Ù‡
            let sha = "";
            let products = [];
            
            try {
                const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${JSON_PATH}?t=${Date.now()}`, {
                    headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
                });
                if (res.ok) {
                    const data = await res.json();
                    sha = data.sha;
                    // ÙÙƒ ØªØ´ÙÙŠØ± Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (UTF-8)
                    products = JSON.parse(decodeURIComponent(escape(atob(data.content))));
                }
            } catch (e) { console.log("New file will be created"); }

            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¬Ø¯ÙŠØ¯
            const newProduct = {
                id: Date.now(),
                title: document.getElementById('title').value,
                category: document.getElementById('category').value,
                priceDinar: document.getElementById('priceDinar').value,
                priceDollar: document.getElementById('priceDollar').value,
                sellerLink: document.getElementById('sellerLink').value,
                image: imageUrl
            };
            products.push(newProduct);

            // 4. Ø±ÙØ¹ Ù…Ù„Ù JSON Ø§Ù„Ù…Ø­Ø¯Ø« Ø¨Ø¯Ø¹Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
            const updatedContent = btoa(unescape(encodeURIComponent(JSON.stringify(products, null, 2))));

            const finalRes = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${JSON_PATH}`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: "Update products list",
                    content: updatedContent,
                    sha: sha
                })
            });

            if (finalRes.ok) {
                status.className = "success";
                status.innerHTML = "ØªÙ… Ù†Ø´Ø± Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­ ÙˆØ¸Ù‡ÙˆØ±Ù‡ ÙÙŠ Ø§Ù„Ù…ØªØ¬Ø±! ğŸ‰";
                // Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„
                document.querySelectorAll('input').forEach(i => i.value = "");
            } else {
                throw new Error("ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
            }

        } catch (err) {
            status.className = "error";
            status.innerHTML = "Ø®Ø·Ø£: ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØªÙˆÙƒÙ† ÙˆØµÙ„Ø§Ø­ÙŠØ§ØªÙ‡! âŒ";
            console.error(err);
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Ù†Ø´Ø± Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¢Ù†';
        }
    }

    const toBase64 = file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });
</script>

</body>
</html>
