<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DZ-STORE Admin | Advanced</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); padding: 20px; direction: ltr; }
        .container { max-width: 700px; margin: auto; background: white; padding: 30px; border-radius: 12px; shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
        
        /* Middlemen Checkbox Style */
        .middlemen-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: #f1f5f9; padding: 15px; border-radius: 8px; }
        .check-item { display: flex; align-items: center; gap: 8px; font-size: 0.9rem; }
        .check-item input { width: auto; }

        /* Images Preview */
        .img-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
        .img-preview { width: 100%; height: 80px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; }
        
        button { background: var(--primary); color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; width: 100%; font-weight: bold; margin-top: 20px; }
        #status { margin-top: 20px; text-align: center; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h2>Add New Account / Service</h2>
    
    <div class="form-group">
        <label>Token (GitHub Key):</label>
        <input type="password" id="token" placeholder="Enter your token">
    </div>

    <div class="form-group">
        <label>Product Title:</label>
        <input type="text" id="title">
    </div>

    <div class="form-group">
        <label>Category:</label>
        <select id="category">
            <option value="efootball">efootball</option>
            <option value="free fire">free fire</option>
            <option value="google play">google play</option>
            <option value="$">$</option>
        </select>
    </div>

    <div class="form-group">
        <label>Description (Details):</label>
        <textarea id="desc" rows="4" placeholder="Write account specs here..."></textarea>
    </div>

    <div style="display:flex; gap:10px;">
        <div class="form-group" style="flex:1">
            <label>Price (DA):</label>
            <input type="number" id="priceDA">
        </div>
        <div class="form-group" style="flex:1">
            <label>Price ($):</label>
            <input type="number" id="priceUSD">
        </div>
    </div>

    <div class="form-group">
        <label>Facebook Seller Link:</label>
        <input type="url" id="link">
    </div>

    <div class="form-group">
        <label>Select Accepted Middlemen (ÿßŸÑŸàÿ≥ÿ∑ÿßÿ°):</label>
        <div class="middlemen-grid" id="middlemen">
            <label class="check-item"><input type="checkbox" value="ÿßÿ≠ŸÖÿØ ŸÅÿ±ŸÇÿßŸÜ"> ÿßÿ≠ŸÖÿØ ŸÅÿ±ŸÇÿßŸÜ</label>
            <label class="check-item"><input type="checkbox" value="ŸÅÿßÿ≠ ÿ®ŸàŸÉÿ±ÿßÿπ"> ŸÅÿßÿ≠ ÿ®ŸàŸÉÿ±ÿßÿπ</label>
            <label class="check-item"><input type="checkbox" value="ÿßŸÜŸäÿ≥ ÿ¥Ÿàÿ®"> ÿßŸÜŸäÿ≥ ÿ¥Ÿàÿ®</label>
            <label class="check-item"><input type="checkbox" value="Ÿàÿ≥Ÿäÿ∑ ÿ¢ÿÆÿ±"> Ÿàÿ≥Ÿäÿ∑ ÿ¢ÿÆÿ±</label>
        </div>
    </div>

    <div class="form-group">
        <label>Upload Images (Max 6):</label>
        <input type="file" id="images" accept="image/*" multiple onchange="previewImages()">
        <div class="img-grid" id="previewContainer"></div>
    </div>

    <button onclick="publish()" id="submitBtn">Publish Product</button>
    <div id="status"></div>
</div>

<script>
    const CONFIG = { owner: 'Cheikh-mimo', repo: 'DZ-STORE', path: 'data/products.json' };

    function previewImages() {
        const container = document.getElementById('previewContainer');
        container.innerHTML = "";
        const files = document.getElementById('images').files;
        if(files.length > 6) { alert("Max 6 images allowed!"); document.getElementById('images').value = ""; return; }
        
        Array.from(files).forEach(file => {
            const reader = new FileReader();
            reader.onload = e => {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'img-preview';
                container.appendChild(img);
            };
            reader.readAsDataURL(file);
        });
    }

    async function publish() {
        const token = document.getElementById('token').value;
        const btn = document.getElementById('submitBtn');
        const status = document.getElementById('status');
        const files = document.getElementById('images').files;

        if(!token || files.length === 0) return alert("Please fill token and images!");

        btn.disabled = true;
        btn.innerText = "Uploading Images (0/" + files.length + ")...";

        try {
            // 1. Upload all images to assets/uploads/
            let uploadedUrls = [];
            for(let i=0; i < files.length; i++) {
                const base64 = await toBase64(files[i]);
                const fileName = `item_${Date.now()}_${i}.png`;
                const res = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/assets/uploads/${fileName}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${token}` },
                    body: JSON.stringify({ message: "upload img", content: base64.split(',')[1] })
                });
                const data = await res.json();
                uploadedUrls.push(data.content.download_url);
                btn.innerText = `Uploading Images (${i+1}/${files.length})...`;
            }

            // 2. Get Selected Middlemen
            const selectedMiddlemen = Array.from(document.querySelectorAll('#middlemen input:checked')).map(el => el.value);

            // 3. Update JSON
            btn.innerText = "Updating Store Data...";
            let sha = "";
            let products = [];
            const getRes = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.path}?t=${Date.now()}`, {
                headers: { 'Authorization': `token ${token}` }
            });

            if(getRes.ok) {
                const data = await getRes.json();
                sha = data.sha;
                products = JSON.parse(decodeURIComponent(escape(atob(data.content))));
            }

            const newProduct = {
                id: Date.now(),
                title: document.getElementById('title').value,
                category: document.getElementById('category').value,
                description: document.getElementById('desc').value,
                priceDinar: document.getElementById('priceDA').value,
                priceDollar: document.getElementById('priceUSD').value,
                sellerLink: document.getElementById('link').value,
                middlemen: selectedMiddlemen,
                image: uploadedUrls[0], // Primary image
                allImages: uploadedUrls // All 6 images
            };

            products.push(newProduct);

            const pushRes = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.path}`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${token}` },
                body: JSON.stringify({
                    message: "Add " + newProduct.title,
                    content: btoa(unescape(encodeURIComponent(JSON.stringify(products, null, 2)))),
                    sha: sha
                })
            });

            if(pushRes.ok) {
                status.style.color = "green";
                status.innerText = "Successfully Published! üéâ";
                setTimeout(() => location.reload(), 2000);
            }

        } catch (err) {
            status.style.color = "red";
            status.innerText = "Error: " + err.message;
        } finally {
            btn.disabled = false;
            btn.innerText = "Publish Product";
        }
    }

    const toBase64 = file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });
</script>
</body>
</html>
