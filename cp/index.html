<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DZ-STORE Admin | الإدارة الكاملة</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --accent: #6366f1; --bg-dark: #0f172a; --card-bg: rgba(30, 41, 59, 0.7);
            --text-main: #f8fafc; --danger: #ef4444; --success: #10b981;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { background: var(--bg-dark); color: var(--text-main); min-height: 100vh; direction: rtl; }
        .hidden { display: none !important; }
        .container { max-width: 1100px; margin: auto; padding: 20px; }
        .glass-card { background: var(--card-bg); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 25px; }
        
        /* Form Styling */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        label { display: block; font-size: 14px; margin-bottom: 5px; color: var(--accent); font-weight: 600; }
        input, select, textarea { width: 100%; padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: white; }
        
        /* Middlemen Checkboxes */
        .middlemen-box { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; background: rgba(255,255,255,0.03); padding: 15px; border-radius: 10px; margin: 10px 0 20px 0; }
        .check-item { display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer; }
        .check-item input { width: auto; margin: 0; cursor: pointer; }

        /* Buttons */
        .btn { padding: 12px 20px; border-radius: 10px; border: none; cursor: pointer; font-weight: 600; transition: 0.3s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--accent); color: white; width: 100%; justify-content: center; font-size: 16px; }
        .btn-danger { background: rgba(239, 68, 68, 0.2); color: var(--danger); border: 1px solid var(--danger); }
        .btn-danger:hover { background: var(--danger); color: white; }

        /* Product Cards */
        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 30px; }
        .p-card { background: var(--card-bg); border: 1px solid rgba(255,255,255,0.08); border-radius: 15px; padding: 15px; }
        .p-card img { width: 100%; height: 160px; object-fit: cover; border-radius: 10px; }
        .p-info { margin-top: 12px; }
        .badge { font-size: 11px; padding: 2px 8px; border-radius: 5px; background: var(--accent); margin-left: 5px; }
        .price-tag { display: flex; justify-content: space-between; margin-top: 10px; font-weight: 700; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px; }
        
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
    </style>
</head>
<body>

<div class="container">
    <div id="login-screen" class="glass-card" style="max-width: 400px; margin: 100px auto; text-align: center;">
        <h2 style="margin-bottom: 20px;">DZ-STORE Admin</h2>
        <input type="password" id="ghToken" placeholder="أدخل توكن GitHub (ghp_...)">
        <button class="btn btn-primary" style="margin-top: 15px;" onclick="login()">دخول</button>
    </div>

    <div id="admin-panel" class="hidden">
        <header>
            <h2>لوحة التحكم <span style="font-size: 14px; color: var(--accent);">Cheikh-mimo</span></h2>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" id="add-btn" onclick="toggleView('add')">+ إضافة منتج</button>
                <button class="btn btn-danger" onclick="logout()">خروج</button>
            </div>
        </header>

        <div id="list-view">
            <div class="products-grid" id="products-grid"></div>
        </div>

        <div id="add-view" class="hidden glass-card">
            <h3 style="margin-bottom: 20px;">إضافة منتج أو حساب جديد</h3>
            <form id="productForm">
                <div class="form-grid">
                    <div><label>اسم المنتج</label><input type="text" id="pName" required placeholder="مثلاً: حساب نيتفلكس"></div>
                    <div><label>الفئة</label>
                        <select id="pCategory">
                            <option value="تواصل اجتماعي">تواصل اجتماعي</option>
                            <option value="ألعاب">ألعاب</option>
                            <option value="بث مباشر">بث مباشر (Streaming)</option>
                            <option value="برامج">برامج وخدمات</option>
                        </select>
                    </div>
                </div>

                <div class="form-grid">
                    <div><label>السعر بالدينار (DA)</label><input type="number" id="pPriceDA" required placeholder="0.00"></div>
                    <div><label>السعر بالدولار ($)</label><input type="number" id="pPriceUSD" required placeholder="0.00"></div>
                </div>

                <label>الوسطاء المعتمدون لهذا المنتج:</label>
                <div class="middlemen-box">
                    <label class="check-item"><input type="checkbox" class="mid-check" value="أحمد فرقان"> أحمد فرقان</label>
                    <label class="check-item"><input type="checkbox" class="mid-check" value="فاح بوكراع"> فاح بوكراع</label>
                    <label class="check-item"><input type="checkbox" class="mid-check" value="أنيس شوب"> أنيس شوب</label>
                </div>

                <label>وصف المنتج / الضمان</label>
                <textarea id="pDesc" rows="3" placeholder="اكتب تفاصيل المنتج هنا..."></textarea>
                
                <label style="margin-top: 15px;">صور المنتج (حتى 6 صور)</label>
                <input type="file" id="pFiles" multiple accept="image/*" onchange="previewImages(this)">
                <div id="preview-container" style="display: flex; gap: 8px; margin: 10px 0;"></div>

                <button type="submit" class="btn btn-primary">نشر المنتج في المتجر ✅</button>
                <button type="button" class="btn" style="width:100%; margin-top:10px; color: #94a3b8;" onclick="toggleView('list')">إلغاء والعودة</button>
            </form>
        </div>
    </div>
</div>

<script>
    // تم تعديل المسار هنا ليصبح data/products.json
    const REPO = { 
        owner: "Cheikh-mimo", 
        repo: "DZ-STORE", 
        path: "data/products.json" 
    };
    
    let base64Images = [];

    function login() {
        const t = document.getElementById('ghToken').value;
        if(t.startsWith('ghp_')) { localStorage.setItem('dz_key', t); location.reload(); }
        else { Swal.fire('خطأ', 'التوكن غير صحيح', 'error'); }
    }

    function logout() { localStorage.removeItem('dz_key'); location.reload(); }

    function toggleView(v) {
        document.getElementById('list-view').classList.toggle('hidden', v === 'add');
        document.getElementById('add-view').classList.toggle('hidden', v === 'list');
        document.getElementById('add-btn').classList.toggle('hidden', v === 'add');
        if(v === 'list') loadProducts();
    }

    async function loadProducts() {
        const grid = document.getElementById('products-grid');
        const token = localStorage.getItem('dz_key');
        grid.innerHTML = "جاري جلب المنتجات...";

        try {
            const res = await fetch(`https://api.github.com/repos/${REPO.owner}/${REPO.repo}/contents/${REPO.path}`, {
                headers: { 'Authorization': `token ${token}` }
            });
            if(!res.ok) throw new Error();
            const data = await res.json();
            const products = JSON.parse(decodeURIComponent(escape(atob(data.content))));
            
            grid.innerHTML = "";
            products.reverse().forEach(p => {
                grid.innerHTML += `
                    <div class="p-card">
                        <img src="${p.images?.[0] || 'https://via.placeholder.com/300x160?text=No+Image'}">
                        <div class="p-info">
                            <span class="badge">${p.category}</span>
                            <h4 style="margin: 8px 0;">${p.name}</h4>
                            <p style="font-size:11px; color:#94a3b8;">الوسطاء: ${p.middlemen.join(' - ') || 'لا يوجد'}</p>
                            <div class="price-tag">
                                <span style="color:var(--success)">${p.priceDA} DA</span>
                                <span style="color:var(--accent)">${p.priceUSD} $</span>
                            </div>
                            <button class="btn btn-danger" onclick="deleteProduct(${p.id})" style="width:100%; margin-top:10px;">حذف المنتج</button>
                        </div>
                    </div>
                `;
            });
        } catch(e) { grid.innerHTML = "لم يتم العثور على المنتجات. تأكد من وجود ملف data/products.json"; }
    }

    function previewImages(input) {
        const container = document.getElementById('preview-container');
        container.innerHTML = ""; base64Images = [];
        Array.from(input.files).slice(0,6).forEach(file => {
            const r = new FileReader();
            r.onload = (e) => {
                base64Images.push(e.target.result);
                container.innerHTML += `<img src="${e.target.result}" style="width:50px; height:50px; border-radius:5px; object-fit:cover;">`;
            };
            r.readAsDataURL(file);
        });
    }

    document.getElementById('productForm').onsubmit = async (e) => {
        e.preventDefault();
        const token = localStorage.getItem('dz_key');
        Swal.fire({ title: 'جاري الرفع...', didOpen: () => Swal.showLoading() });

        try {
            let sha = null; let currentProducts = [];
            const res = await fetch(`https://api.github.com/repos/${REPO.owner}/${REPO.repo}/contents/${REPO.path}`, {
                headers: { 'Authorization': `token ${token}` }
            });
            
            if(res.ok) {
                const data = await res.json();
                sha = data.sha;
                currentProducts = JSON.parse(decodeURIComponent(escape(atob(data.content))));
            }

            const newProduct = {
                id: Date.now(),
                name: document.getElementById('pName').value,
                category: document.getElementById('pCategory').value,
                priceDA: document.getElementById('pPriceDA').value,
                priceUSD: document.getElementById('pPriceUSD').value,
                description: document.getElementById('pDesc').value,
                middlemen: Array.from(document.querySelectorAll('.mid-check:checked')).map(c => c.value),
                images: base64Images
            };

            currentProducts.push(newProduct);

            const update = await fetch(`https://api.github.com/repos/${REPO.owner}/${REPO.repo}/contents/${REPO.path}`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${token}` },
                body: JSON.stringify({
                    message: `Add ${newProduct.name}`,
                    content: btoa(unescape(encodeURIComponent(JSON.stringify(currentProducts)))),
                    sha: sha
                })
            });

            if(update.ok) {
                Swal.fire('تم النشر!', 'تمت إضافة المنتج لمتجرك بنجاح', 'success');
                document.getElementById('productForm').reset();
                toggleView('list');
            }
        } catch(err) { Swal.fire('خطأ', 'تأكد أن مجلد data يحتوي على ملف products.json', 'error'); }
    };

    async function deleteProduct(id) {
        const { isConfirmed } = await Swal.fire({ title: 'هل أنت متأكد؟', text: "سيتم حذف المنتج من المتجر نهائياً", icon: 'warning', showCancelButton: true, confirmButtonText: 'نعم، احذف' });
        if(!isConfirmed) return;

        const token = localStorage.getItem('dz_key');
        const res = await fetch(`https://api.github.com/repos/${REPO.owner}/${REPO.repo}/contents/${REPO.path}`, {
            headers: { 'Authorization': `token ${token}` }
        });
        const data = await res.json();
        let products = JSON.parse(decodeURIComponent(escape(atob(data.content))));
        products = products.filter(p => p.id !== id);

        await fetch(`https://api.github.com/repos/${REPO.owner}/${REPO.repo}/contents/${REPO.path}`, {
            method: 'PUT',
            headers: { 'Authorization': `token ${token}` },
            body: JSON.stringify({
                message: "Delete product",
                content: btoa(unescape(encodeURIComponent(JSON.stringify(products)))),
                sha: data.sha
            })
        });
        loadProducts();
    }

    if(localStorage.getItem('dz_key')) {
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('admin-panel').classList.remove('hidden');
        loadProducts();
    }
</script>
</body>
</html>
