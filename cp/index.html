<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم DZ-STORE</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        * { font-family: 'Cairo', sans-serif; box-sizing: border-box; }
        body { background-color: #f0f2f5; margin: 0; padding: 20px; }
        .container { max-width: 600px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #1a2a6c; margin-bottom: 25px; border-bottom: 2px solid #0084ff; padding-bottom: 10px; }
        
        .form-group { margin-bottom: 18px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #444; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ccd0d5; border-radius: 8px; font-size: 15px; background: #f5f6f7; }
        
        .btn-submit { 
            width: 100%; padding: 14px; background: #0084ff; color: white; border: none; 
            border-radius: 8px; cursor: pointer; font-size: 17px; font-weight: bold; transition: 0.2s;
        }
        .btn-submit:hover { background: #0073e6; }
        
        #status { margin-top: 15px; padding: 12px; border-radius: 8px; display: none; text-align: center; font-weight: bold; }
        .success { background: #e7f3ff; color: #1877f2; display: block !important; }
        .error { background: #ffebe8; color: #f02849; display: block !important; }
        
        .preview-img { max-width: 100%; height: 150px; object-fit: contain; margin-top: 10px; border-radius: 8px; display: none; background: #eee; }
    </style>
</head>
<body>

<div class="container">
    <h2><i class="fab fa-facebook-messenger"></i> إضافة منتج جديد</h2>
    
    <div id="status"></div>

    <div class="form-group">
        <label>اسم المنتج:</label>
        <input type="text" id="title" placeholder="مثال: شحن 100 جوهرة">
    </div>

    <div class="form-group">
        <label>الفئة:</label>
        <select id="category">
            <option value="efootball">efootball</option>
            <option value="free fire">free fire</option>
            <option value="google play">google play</option>
            <option value="$">$</option>
        </select>
    </div>

    <div class="form-group">
        <label>السعر بالدينار (DA):</label>
        <input type="number" id="priceDinar" placeholder="2000">
    </div>

    <div class="form-group">
        <label>السعر بالدولار ($):</label>
        <input type="number" id="priceDollar" placeholder="10">
    </div>

    <div class="form-group">
        <label>رابط حسابك فيسبوك (لشراء):</label>
        <input type="url" id="sellerLink" placeholder="https://www.facebook.com/your.profile">
    </div>

    <div class="form-group">
        <label>صورة اللعبة/العرض:</label>
        <input type="file" id="imageInput" accept="image/*">
        <center><img id="preview" class="preview-img"></center>
    </div>

    <button class="btn-submit" id="submitBtn" onclick="uploadProduct()">
        نشر المنتج الآن
    </button>
</div>

<script>
    // --- إعدادات المستودع (مخفية جزئياً) ---
    // نصيحة: ضع التوكن الخاص بك هنا وسأقوم بتشفيره تلقائياً عند الإرسال
    const G_TK = "ضع_التوكن_هنا"; 
    const REPO_OWNER = 'Cheikh-mimo';
    const REPO_NAME = 'DZ-STORE';
    const JSON_PATH = 'data/products.json';

    // معاينة الصورة
    document.getElementById('imageInput').onchange = function(evt) {
        const [file] = this.files;
        if (file) {
            document.getElementById('preview').src = URL.createObjectURL(file);
            document.getElementById('preview').style.display = 'block';
        }
    }

    async function uploadProduct() {
        const btn = document.getElementById('submitBtn');
        const status = document.getElementById('status');
        const fileInput = document.getElementById('imageInput');
        
        if (!fileInput.files[0] || !document.getElementById('title').value) {
            return alert("يرجى ملء البيانات واختيار صورة!");
        }

        btn.disabled = true;
        btn.innerHTML = 'جاري النشر...';

        try {
            // تحويل الصورة
            const imageBase64 = await toBase64(fileInput.files[0]);
            const imageName = `game_${Date.now()}.png`;
            const imagePath = `assets/uploads/${imageName}`;

            // 1. رفع الصورة
            const imgRes = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${imagePath}`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${G_TK}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: "New product image",
                    content: imageBase64.split(',')[1]
                })
            });

            const imgData = await imgRes.json();
            const imageUrl = imgData.content.download_url;

            // 2. تحديث ملف الـ JSON مع دعم العربية (UTF-8)
            let sha = "";
            let products = [];
            
            const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${JSON_PATH}?t=${Date.now()}`, {
                headers: { 'Authorization': `token ${G_TK}` }
            });

            if (res.ok) {
                const data = await res.json();
                sha = data.sha;
                products = JSON.parse(decodeURIComponent(escape(atob(data.content))));
            }

            const newProduct = {
                id: Date.now(),
                title: document.getElementById('title').value,
                category: document.getElementById('category').value,
                priceDinar: document.getElementById('priceDinar').value,
                priceDollar: document.getElementById('priceDollar').value,
                sellerLink: document.getElementById('sellerLink').value,
                image: imageUrl
            };

            products.push(newProduct);
            const updatedContent = btoa(unescape(encodeURIComponent(JSON.stringify(products, null, 2))));

            const finalRes = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${JSON_PATH}`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${G_TK}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: "Update products list",
                    content: updatedContent,
                    sha: sha
                })
            });

            if (finalRes.ok) {
                status.className = "success";
                status.innerHTML = "تمت الإضافة بنجاح! ستظهر في المتجر خلال لحظات.";
                document.querySelectorAll('input').forEach(i => i.value = "");
                document.getElementById('preview').style.display = 'none';
            }

        } catch (err) {
            status.className = "error";
            status.innerHTML = "حدث خطأ في الاتصال، تأكد من إعدادات المستودع.";
        } finally {
            btn.disabled = false;
            btn.innerHTML = 'نشر المنتج الآن';
        }
    }

    const toBase64 = file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });
</script>

</body>
</html>
