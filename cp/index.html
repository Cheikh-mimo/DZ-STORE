<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DZ-STORE | Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --accent: #6366f1;
            --accent-hover: #4f46e5;
            --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            --glass: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
            --danger: #ef4444;
            --success: #10b981;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        body {
            font-family: 'Cairo', sans-serif;
            background: var(--bg-gradient);
            color: var(--text-main);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .hidden { display: none !important; }

        /* --- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ --- */
        #login-screen {
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .login-card {
            background: var(--glass);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            padding: 40px;
            border-radius: 24px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
        }
        .login-card h1 { margin-bottom: 30px; font-size: 24px; }
        .input-dark {
            width: 100%;
            padding: 14px;
            background: rgba(0,0,0,0.2);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: white;
            margin-bottom: 20px;
            transition: 0.3s;
        }
        .input-dark:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); }

        /* --- Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ --- */
        header {
            padding: 20px 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--glass-border);
        }

        /* --- Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© --- */
        .main-content { padding: 30px 5%; max-width: 1200px; margin: auto; }

        /* --- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… --- */
        .btn {
            padding: 10px 24px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: var(--accent-hover); transform: translateY(-2px); }
        .btn-danger { background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid var(--danger); }
        .btn-danger:hover { background: var(--danger); color: white; }

        /* --- Ø´Ø¨ÙƒØ© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª --- */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }
        .product-card {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 20px;
            transition: 0.3s;
            position: relative;
        }
        .product-card:hover { transform: translateY(-5px); background: rgba(255,255,255,0.06); }
        .product-card h3 { font-size: 18px; margin-bottom: 10px; }
        .product-card .price { font-size: 20px; color: var(--success); font-weight: bold; }
        .product-card .category { font-size: 12px; background: var(--accent); padding: 2px 10px; border-radius: 20px; }
        .card-actions { margin-top: 20px; display: flex; gap: 10px; border-top: 1px solid var(--glass-border); padding-top: 15px; }

        /* --- ÙÙˆØ±Ù… Ø§Ù„Ø¥Ø¶Ø§ÙØ© --- */
        .form-container {
            background: var(--glass);
            padding: 40px;
            border-radius: 24px;
            border: 1px solid var(--glass-border);
            max-width: 800px;
            margin: auto;
        }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .form-grid { grid-template-columns: 1fr; } }

        .upload-box {
            border: 2px dashed var(--glass-border);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: 0.3s;
        }
        .upload-box:hover { border-color: var(--accent); background: rgba(99, 102, 241, 0.05); }

        #imagePreview { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; }
        .preview-img { width: 80px; height: 80px; object-fit: cover; border-radius: 10px; border: 1px solid var(--accent); }

    </style>
</head>
<body>

    <section id="login-screen">
        <div class="login-card">
            <h1>DZ-STORE Login</h1>
            <p style="color: var(--text-dim); margin-bottom: 20px;">Ø£Ø¯Ø®Ù„ ØªÙˆÙƒÙ† GitHub Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹</p>
            <input type="password" id="ghToken" class="input-dark" placeholder="ghp_xxxxxxxxxxxx">
            <button class="btn btn-primary" style="width: 100%" onclick="handleLogin()">ØªØ­Ù‚Ù‚ ÙˆØ¯Ø®ÙˆÙ„</button>
        </div>
    </section>

    <main id="admin-panel" class="hidden">
        <header>
            <h2 style="font-weight: 700;">DZ-STORE <span style="font-weight: 400; color: var(--accent);">Admin</span></h2>
            <div style="display: flex; gap: 15px;">
                <button class="btn btn-primary" onclick="showView('add-view')" id="nav-add-btn">+ Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</button>
                <button class="btn btn-primary" onclick="showView('list-view')" id="nav-list-btn" class="hidden">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>
                <button class="btn btn-danger" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
            </div>
        </header>

        <div class="main-content">
            
            <div id="list-view">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø©</h3>
                    <p id="product-count" style="color: var(--text-dim);"></p>
                </div>
                <div class="products-grid" id="productsGrid">
                    </div>
            </div>

            <div id="add-view" class="hidden">
                <div class="form-container">
                    <h3 style="margin-bottom: 25px;">Ø¥Ø¶Ø§ÙØ© Ø®Ø¯Ù…Ø©/Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</h3>
                    <form id="productForm">
                        <div class="form-grid">
                            <div>
                                <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label>
                                <input type="text" id="pName" class="input-dark" required>
                            </div>
                            <div>
                                <label>Ø§Ù„ÙØ¦Ø©</label>
                                <select id="pCategory" class="input-dark" required>
                                    <option value="social">ØªÙˆØ§ØµÙ„ Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ</option>
                                    <option value="gaming">Ø£Ù„Ø¹Ø§Ø¨</option>
                                    <option value="streaming">Ø¨Ø« Ù…Ø¨Ø§Ø´Ø±</option>
                                    <option value="software">Ø¨Ø±Ø§Ù…Ø¬</option>
                                </select>
                            </div>
                            <div>
                                <label>Ø§Ù„Ø³Ø¹Ø± (DA)</label>
                                <input type="number" id="pPrice" class="input-dark" required>
                            </div>
                            <div>
                                <label>Ø§Ù„Ø¶Ù…Ø§Ù† / Ø§Ù„Ù…Ø¯Ø©</label>
                                <input type="text" id="pWarranty" class="input-dark" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø¶Ù…Ø§Ù† 30 ÙŠÙˆÙ…">
                            </div>
                        </div>
                        
                        <label>ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬</label>
                        <textarea id="pDesc" class="input-dark" rows="4"></textarea>

                        <div class="upload-box" onclick="document.getElementById('fileInput').click()">
                            <span>ğŸ“ Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± (Ø­ØªÙ‰ 6 ØµÙˆØ±)</span>
                            <input type="file" id="fileInput" class="hidden" multiple accept="image/*" onchange="handleFiles(this)">
                        </div>
                        <div id="imagePreview"></div>

                        <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 30px; padding: 18px;">Ù†Ø´Ø± Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¢Ù†</button>
                        <button type="button" class="btn" style="width: 100%; margin-top: 10px;" onclick="showView('list-view')">Ø¥Ù„ØºØ§Ø¡</button>
                    </form>
                </div>
            </div>

        </div>
    </main>

    <script>
        const REPO_CONFIG = {
            owner: "Cheikh-mimo",
            repo: "DZ-STORE",
            path: "products.json"
        };

        let currentProducts = [];
        let base64Images = [];

        // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙ†Ù‚Ù„
        function showView(viewId) {
            document.getElementById('list-view').classList.add('hidden');
            document.getElementById('add-view').classList.add('hidden');
            document.getElementById(viewId).classList.remove('hidden');
            
            if(viewId === 'list-view') {
                document.getElementById('nav-add-btn').classList.remove('hidden');
                document.getElementById('nav-list-btn').classList.add('hidden');
                fetchProducts();
            } else {
                document.getElementById('nav-add-btn').classList.add('hidden');
                document.getElementById('nav-list-btn').classList.remove('hidden');
            }
        }

        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        function handleLogin() {
            const token = document.getElementById('ghToken').value;
            if(token.startsWith('ghp_')) {
                localStorage.setItem('dz_gh_token', token);
                startApp();
            } else {
                Swal.fire('Ø®Ø·Ø£', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ØªÙˆÙƒÙ† ØµØ­ÙŠØ­', 'error');
            }
        }

        function logout() {
            localStorage.removeItem('dz_gh_token');
            location.reload();
        }

        function startApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('admin-panel').classList.remove('hidden');
            fetchProducts();
        }

        // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        async function fetchProducts() {
            const token = localStorage.getItem('dz_gh_token');
            const grid = document.getElementById('productsGrid');
            grid.innerHTML = '<p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...</p>';

            try {
                const res = await fetch(`https://api.github.com/repos/${REPO_CONFIG.owner}/${REPO_CONFIG.repo}/contents/${REPO_CONFIG.path}`, {
                    headers: { 'Authorization': `token ${token}` }
                });
                const data = await res.json();
                currentProducts = JSON.parse(decodeURIComponent(escape(atob(data.content))));
                renderProducts();
            } catch (err) {
                grid.innerHTML = '<p style="color:var(--danger)">ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„. ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ù„Ù products.json</p>';
            }
        }

        function renderProducts() {
            const grid = document.getElementById('productsGrid');
            document.getElementById('product-count').innerText = `${currentProducts.length} Ù…Ù†ØªØ¬`;
            grid.innerHTML = '';

            currentProducts.reverse().forEach(p => {
                grid.innerHTML += `
                    <div class="product-card">
                        <span class="category">${p.category}</span>
                        <h3 style="margin-top:15px">${p.name}</h3>
                        <p class="price">${p.price} DA</p>
                        <div class="card-actions">
                            <button class="btn btn-danger" style="flex:1" onclick="deleteProduct(${p.id})">Ø­Ø°Ù</button>
                        </div>
                    </div>
                `;
            });
        }

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±
        function handleFiles(input) {
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = '';
            base64Images = [];
            
            Array.from(input.files).slice(0,6).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    base64Images.push(e.target.result);
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'preview-img';
                    preview.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
        }

        // Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬
        document.getElementById('productForm').onsubmit = async (e) => {
            e.preventDefault();
            const token = localStorage.getItem('dz_gh_token');
            
            Swal.fire({ title: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù†Ø´Ø±...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            try {
                // 1. Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ SHA
                const res = await fetch(`https://api.github.com/repos/${REPO_CONFIG.owner}/${REPO_CONFIG.repo}/contents/${REPO_CONFIG.path}`, {
                    headers: { 'Authorization': `token ${token}` }
                });
                const fileData = await res.json();
                const products = JSON.parse(decodeURIComponent(escape(atob(fileData.content))));

                // 2. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                const newProduct = {
                    id: Date.now(),
                    name: document.getElementById('pName').value,
                    category: document.getElementById('pCategory').value,
                    price: document.getElementById('pPrice').value,
                    description: document.getElementById('pDesc').value,
                    warranty: document.getElementById('pWarranty').value,
                    images: base64Images
                };

                products.push(newProduct);

                // 3. Ø±ÙØ¹ Ø§Ù„ØªØ­Ø¯ÙŠØ«
                const update = await fetch(`https://api.github.com/repos/${REPO_CONFIG.owner}/${REPO_CONFIG.repo}/contents/${REPO_CONFIG.path}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${token}` },
                    body: JSON.stringify({
                        message: `Add ${newProduct.name}`,
                        content: btoa(unescape(encodeURIComponent(JSON.stringify(products, null, 2)))),
                        sha: fileData.sha
                    })
                });

                if(update.ok) {
                    Swal.fire('ØªÙ…!', 'ØªÙ… Ù†Ø´Ø± Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                    document.getElementById('productForm').reset();
                    showView('list-view');
                }
            } catch (err) {
                Swal.fire('Ø®Ø·Ø£', 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ GitHub', 'error');
            }
        };

        // Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬
        async function deleteProduct(id) {
            const result = await Swal.fire({
                title: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ',
                text: "Ù„Ù† ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ø°Ù",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù',
                cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
            });

            if (result.isConfirmed) {
                const token = localStorage.getItem('dz_gh_token');
                try {
                    const res = await fetch(`https://api.github.com/repos/${REPO_CONFIG.owner}/${REPO_CONFIG.repo}/contents/${REPO_CONFIG.path}`, {
                        headers: { 'Authorization': `token ${token}` }
                    });
                    const fileData = await res.json();
                    let products = JSON.parse(decodeURIComponent(escape(atob(fileData.content))));
                    
                    products = products.filter(p => p.id !== id);

                    await fetch(`https://api.github.com/repos/${REPO_CONFIG.owner}/${REPO_CONFIG.repo}/contents/${REPO_CONFIG.path}`, {
                        method: 'PUT',
                        headers: { 'Authorization': `token ${token}` },
                        body: JSON.stringify({
                            message: "Delete product",
                            content: btoa(unescape(encodeURIComponent(JSON.stringify(products, null, 2)))),
                            sha: fileData.sha
                        })
                    });
                    
                    Swal.fire('ØªÙ…!', 'ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­', 'success');
                    fetchProducts();
                } catch (e) {
                    Swal.fire('Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ù…Ø´ÙƒÙ„Ø© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù', 'error');
                }
            }
        }

        // ÙØ­Øµ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        if(localStorage.getItem('dz_gh_token')) startApp();
    </script>
</body>
</html>
