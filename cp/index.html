<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DZ-STORE | Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --accent: #6366f1;
            --bg-dark: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.7);
            --text-main: #f8fafc;
            --danger: #ef4444;
            --success: #10b981;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { background: var(--bg-dark); color: var(--text-main); min-height: 100vh; direction: rtl; }
        .hidden { display: none !important; }

        /* Ø§Ù„Ø´Ø§Ø´Ø§Øª */
        .container { max-width: 1200px; margin: auto; padding: 20px; }
        .glass-card { background: var(--card-bg); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 30px; }

        /* Ø£Ø²Ø±Ø§Ø± */
        .btn { padding: 12px 25px; border-radius: 12px; border: none; cursor: pointer; font-weight: 600; transition: 0.3s; gap: 8px; display: inline-flex; align-items: center; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--accent); color: var(--accent); }

        /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª */
        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 30px; }
        .p-card { background: rgba(255,255,255,0.05); border-radius: 15px; padding: 15px; border: 1px solid rgba(255,255,255,0.05); }
        .p-card img { width: 100%; height: 150px; object-fit: cover; border-radius: 10px; margin-bottom: 10px; }

        /* Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª */
        input, select, textarea { width: 100%; padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: white; margin-top: 8px; margin-bottom: 15px; }
        
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; }
    </style>
</head>
<body>

<div class="container">
    <div id="login-screen" class="glass-card" style="max-width: 450px; margin: 100px auto; text-align: center;">
        <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ Cheikh-mimo ğŸ‘‹</h2>
        <p style="margin-bottom: 25px; opacity: 0.7;">Ø£Ø¯Ø®Ù„ Ø§Ù„ØªÙˆÙƒÙ† Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ DZ-STORE</p>
        <input type="password" id="ghToken" placeholder="ghp_xxxxxxxxxxxx">
        <button class="btn btn-primary" style="width: 100%;" onclick="login()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
    </div>

    <div id="admin-panel" class="hidden">
        <header>
            <h1>DZ-STORE <span style="color:var(--accent)">Admin</span></h1>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" id="add-nav-btn" onclick="toggleView('add')">+ Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</button>
                <button class="btn btn-outline hidden" id="list-nav-btn" onclick="toggleView('list')">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
                <button class="btn btn-danger" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
            </div>
        </header>

        <div id="list-view">
            <h3>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ØªÙˆÙØ±Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</h3>
            <div id="products-grid" class="products-grid">
                </div>
        </div>

        <div id="add-view" class="hidden glass-card">
            <h3>Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</h3>
            <form id="productForm">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div><label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label><input type="text" id="pName" required></div>
                    <div><label>Ø§Ù„ØªØµÙ†ÙŠÙ</label>
                        <select id="pCategory">
                            <option value="social">ØªÙˆØ§ØµÙ„ Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ</option>
                            <option value="gaming">Ø£Ù„Ø¹Ø§Ø¨</option>
                            <option value="streaming">Ø¨Ø« Ù…Ø¨Ø§Ø´Ø±</option>
                            <option value="software">Ø¨Ø±Ø§Ù…Ø¬</option>
                        </select>
                    </div>
                </div>
                <label>Ø§Ù„Ø³Ø¹Ø± (DA)</label><input type="number" id="pPrice" required>
                <label>ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬</label><textarea id="pDesc" rows="3"></textarea>
                
                <label>ØµÙˆØ± Ø§Ù„Ù…Ù†ØªØ¬</label>
                <input type="file" id="pFiles" multiple accept="image/*" onchange="previewImages(this)">
                <div id="preview-container" style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;"></div>

                <button type="submit" class="btn btn-primary" style="width: 100%;">Ù†Ø´Ø± Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹</button>
            </form>
        </div>
    </div>
</div>

<script>
    const CONFIG = {
        owner: "Cheikh-mimo",
        repo: "DZ-STORE",
        path: "products.json"
    };

    let base64Images = [];

    function login() {
        const token = document.getElementById('ghToken').value;
        if(token.includes('ghp_')) {
            localStorage.setItem('dz_token', token);
            location.reload();
        } else {
            Swal.fire('Ø®Ø·Ø£', 'Ø§Ù„ØªÙˆÙƒÙ† ØºÙŠØ± ØµØ­ÙŠØ­', 'error');
        }
    }

    function logout() {
        localStorage.removeItem('dz_token');
        location.reload();
    }

    function toggleView(view) {
        if(view === 'add') {
            document.getElementById('list-view').classList.add('hidden');
            document.getElementById('add-view').classList.remove('hidden');
            document.getElementById('add-nav-btn').classList.add('hidden');
            document.getElementById('list-nav-btn').classList.remove('hidden');
        } else {
            document.getElementById('add-view').classList.add('hidden');
            document.getElementById('list-view').classList.remove('hidden');
            document.getElementById('list-nav-btn').classList.add('hidden');
            document.getElementById('add-nav-btn').classList.remove('hidden');
            loadProducts();
        }
    }

    async function loadProducts() {
        const grid = document.getElementById('products-grid');
        const token = localStorage.getItem('dz_token');
        grid.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";

        try {
            const res = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.path}`, {
                headers: { 'Authorization': `token ${token}` }
            });

            if(res.status === 404) {
                grid.innerHTML = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø¹Ø¯. Ù‚Ù… Ø¨Ø¥Ø¶Ø§ÙØ© Ø£ÙˆÙ„ Ù…Ù†ØªØ¬!";
                return;
            }

            const data = await res.json();
            const products = JSON.parse(decodeURIComponent(escape(atob(data.content))));
            
            grid.innerHTML = "";
            products.reverse().forEach(p => {
                grid.innerHTML += `
                    <div class="p-card">
                        <img src="${p.images?.[0] || 'https://via.placeholder.com/150'}">
                        <h4>${p.name}</h4>
                        <p style="color:var(--accent)">${p.price} DA</p>
                        <button class="btn btn-danger" onclick="deleteProduct(${p.id})" style="width:100%; margin-top:10px; font-size:12px;">Ø­Ø°Ù</button>
                    </div>
                `;
            });
        } catch(e) {
            grid.innerHTML = "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.";
        }
    }

    function previewImages(input) {
        const container = document.getElementById('preview-container');
        container.innerHTML = "";
        base64Images = [];
        Array.from(input.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => {
                base64Images.push(e.target.result);
                container.innerHTML += `<img src="${e.target.result}" style="width:60px; height:60px; border-radius:5px; object-fit:cover;">`;
            };
            reader.readAsDataURL(file);
        });
    }

    document.getElementById('productForm').onsubmit = async (e) => {
        e.preventDefault();
        const token = localStorage.getItem('dz_token');
        Swal.fire({ title: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...', didOpen: () => Swal.showLoading() });

        let currentProducts = [];
        let sha = null;

        try {
            // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø­Ø§Ù„ÙŠ
            const res = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.path}`, {
                headers: { 'Authorization': `token ${token}` }
            });
            
            if(res.ok) {
                const data = await res.json();
                sha = data.sha;
                currentProducts = JSON.parse(decodeURIComponent(escape(atob(data.content))));
            }

            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¬Ø¯ÙŠØ¯
            const newProduct = {
                id: Date.now(),
                name: document.getElementById('pName').value,
                category: document.getElementById('pCategory').value,
                price: document.getElementById('pPrice').value,
                description: document.getElementById('pDesc').value,
                images: base64Images
            };
            currentProducts.push(newProduct);

            // Ø±ÙØ¹ Ø§Ù„ØªØ­Ø¯ÙŠØ«
            const update = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.path}`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${token}` },
                body: JSON.stringify({
                    message: "Update products",
                    content: btoa(unescape(encodeURIComponent(JSON.stringify(currentProducts)))),
                    sha: sha
                })
            });

            if(update.ok) {
                Swal.fire('Ù†Ø¬Ø§Ø­', 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                document.getElementById('productForm').reset();
                toggleView('list');
            } else {
                throw new Error();
            }
        } catch(err) {
            Swal.fire('Ø®Ø·Ø£', 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ GitHub. ØªØ£ÙƒØ¯ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ØªÙˆÙƒÙ†.', 'error');
        }
    };

    async function deleteProduct(id) {
        const token = localStorage.getItem('dz_token');
        const res = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.path}`, {
            headers: { 'Authorization': `token ${token}` }
        });
        const data = await res.json();
        let products = JSON.parse(decodeURIComponent(escape(atob(data.content))));
        products = products.filter(p => p.id !== id);

        await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.path}`, {
            method: 'PUT',
            headers: { 'Authorization': `token ${token}` },
            body: JSON.stringify({
                message: "Delete product",
                content: btoa(unescape(encodeURIComponent(JSON.stringify(products)))),
                sha: data.sha
            })
        });
        loadProducts();
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø©
    if(localStorage.getItem('dz_token')) {
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('admin-panel').classList.remove('hidden');
        loadProducts();
    }
</script>
</body>
</html>
